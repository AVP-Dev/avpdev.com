---
// src/components/sections/Contact.astro
import { getLangFromUrl, useTranslations } from "../../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---

<section id="contact">
    <div class="container container-narrow">
        <div class="section-center">
            <h2 class="section-title fade-in" set:html={t("contact_h2")} />
            <p class="section-subtitle fade-in">{t("contact_p")}</p>
        </div>

        <form id="contact-form" class="contact-form fade-in" novalidate>
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label">{t("form_name")}</label>
                    <input
                        type="text"
                        name="name"
                        placeholder="John Doe"
                        required
                        class="form-control"
                    />
                </div>

                <div class="form-group">
                    <label class="form-label">{t("form_email")}</label>
                    <input
                        type="text"
                        name="contact"
                        placeholder="Email / Telegram / Phone"
                        class="form-control"
                        required
                    />
                    <span class="form-hint-text">{t("form_hint")}</span>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">{t("form_message")}</label>
                    <textarea
                        name="message"
                        placeholder={t("form_message")}
                        required
                        class="form-control"
                        rows="5"></textarea>
                    <div class="message-info">
                        <span class="form-hint-text"
                            >{t("form_error_message_short")}</span
                        >
                        <span id="char-counter" class="char-counter"
                            >0 / 2000</span
                        >
                    </div>
                    <p id="message-error" class="error-text hidden">
                        {t("form_error_message_short")}
                    </p>
                </div>
            </div>

            <div class="form-footer">
                <div class="checkbox-wrapper">
                    <input
                        type="checkbox"
                        id="legal-consent"
                        name="consent"
                        class="custom-checkbox"
                        required
                    />
                    <label for="legal-consent" class="checkbox-label">
                        {
                            lang === "ru" ? (
                                <>
                                    –Ø –ø—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è{" "}
                                    <a href="/ru/legal/public-offer">
                                        –ü—É–±–ª–∏—á–Ω–æ–π –æ—Ñ–µ—Ä—Ç—ã
                                    </a>{" "}
                                    –∏ –¥–∞—é —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É{" "}
                                    <a href="/ru/legal/privacy-policy">
                                        –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                                    </a>
                                    .
                                </>
                            ) : (
                                <>
                                    I accept the{" "}
                                    <a href="/en/legal/public-offer">
                                        Public Offer
                                    </a>{" "}
                                    and agree to the processing of{" "}
                                    <a href="/en/legal/privacy-policy">
                                        personal data
                                    </a>
                                    .
                                </>
                            )
                        }
                    </label>
                </div>

                <div class="submit-area">
                    <button id="submit-button" type="submit" class="cta-button">
                        <span style="margin-right: 12px;"
                            >{t("form_button")}</span
                        >
                        <i class="fas fa-paper-plane"></i>
                    </button>
                    <div
                        id="form-spinner"
                        class="spinner"
                        style="display: none;"
                    >
                    </div>
                </div>

                <p id="consent-error" class="error-text hidden">
                    {
                        lang === "ru"
                            ? "–í—ã –¥–æ–ª–∂–Ω—ã —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö."
                            : "You must agree to personal data processing."
                    }
                </p>
            </div>
        </form>
    </div>
</section>

<style>
    .container-narrow {
        max-width: 800px;
    }

    .section-center {
        text-align: center;
        margin-bottom: 4rem;
    }

    .badge {
        display: inline-block;
        padding: 4px 12px;
        background: var(--tag-bg);
        color: var(--tag-text);
        border-radius: 6px;
        font-family: var(--font-mono);
        font-size: 0.8rem;
        margin-bottom: 1rem;
        font-weight: 600;
    }

    .contact-form {
        background: var(--primary-color);
        padding: 3rem;
        border-radius: 24px;
        border: 1px solid var(--border-color);
        box-shadow: var(--card-shadow);
    }

    .submit-area {
        display: flex;
        justify-content: center;
    }

    .form-hint-text {
        display: block;
        font-size: 0.75rem;
        color: var(--text-secondary-color);
        margin-top: 0.5rem;
        font-family: var(--font-mono);
        opacity: 0.7;
    }

    @media (max-width: 640px) {
        .contact-form {
            padding: 1.5rem;
        }
        .form-grid {
            grid-template-columns: 1fr;
        }
        .full-width {
            grid-column: span 1;
        }
    }

    .message-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.5rem;
    }

    .char-counter {
        font-size: 0.75rem;
        color: var(--text-secondary-color);
        font-family: var(--font-mono);
        opacity: 0.7;
    }

    .message-info .form-hint-text {
        margin-top: 0;
    }
</style>

<script>
    import { navigate } from "astro:transitions/client";

    document.addEventListener("astro:page-load", () => {
        const form = document.getElementById("contact-form") as HTMLFormElement;
        const submitButton = document.getElementById(
            "submit-button",
        ) as HTMLButtonElement;
        const spinner = document.getElementById("form-spinner") as HTMLElement;
        const consentCheckbox = document.getElementById(
            "legal-consent",
        ) as HTMLInputElement;
        const consentError = document.getElementById(
            "consent-error",
        ) as HTMLElement;
        const messageError = document.getElementById(
            "message-error",
        ) as HTMLElement;
        const messageInput = form.querySelector(
            'textarea[name="message"]',
        ) as HTMLTextAreaElement;
        const charCounter = document.getElementById("char-counter");

        if (!form) return;

        // Character counter logic
        if (messageInput && charCounter) {
            messageInput.addEventListener("input", () => {
                const length = messageInput.value.length;
                charCounter.textContent = `${length} / 2000`;

                if (length > 0 && length < 10) {
                    (charCounter as HTMLElement).style.color = "#ef4444";
                } else {
                    (charCounter as HTMLElement).style.color = "";
                }
            });
        }

        form.addEventListener("submit", async (e) => {
            e.preventDefault();

            // Reset errors
            form.querySelectorAll(".error-field").forEach((el) =>
                el.classList.remove("error-field"),
            );
            if (consentError) consentError.classList.add("hidden");
            if (messageError) messageError.classList.add("hidden");

            let isValid = true;

            // Validate text inputs
            form.querySelectorAll(
                "input[required], textarea[required]",
            ).forEach((field) => {
                const input = field as HTMLInputElement | HTMLTextAreaElement;
                if (!input.value.trim()) {
                    input.classList.add("error-field");
                    isValid = false;
                }
            });

            // Validate message length (min 10)
            if (messageInput && messageInput.value.trim().length < 10) {
                messageInput.classList.add("error-field");
                if (messageError) messageError.classList.remove("hidden");
                isValid = false;
            }

            // Validate consent
            if (!consentCheckbox.checked) {
                consentCheckbox.classList.add("error-field");
                if (consentError) consentError.classList.remove("hidden");
                isValid = false;
            }

            if (!isValid) return;

            // Show loading state
            if (submitButton) submitButton.style.display = "none";
            if (spinner) spinner.style.display = "block";

            const formData = new FormData(form);
            // Use 'any' type to allow boolean conversion
            const data: Record<string, any> = Object.fromEntries(
                formData.entries(),
            );

            // CRITICAL: Convert checkbox from "on"/undefined to boolean
            data.consent = formData.get("consent") === "on";

            console.log("üì§ Sending contact form data:", data);

            try {
                const response = await fetch("/api/sendMessage/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    document.dispatchEvent(
                        new CustomEvent("modal:open", {
                            detail: { modalId: "success-modal" },
                        }),
                    );
                    form.reset();
                    if (charCounter) charCounter.textContent = "0 / 2000";
                } else {
                    const errorData = await response.json();
                    if (errorData.errors && errorData.errors.message) {
                        if (messageError) {
                            messageError.textContent =
                                errorData.errors.message[0];
                            messageError.classList.remove("hidden");
                            messageInput.classList.add("error-field");
                        }
                        throw new Error("Validation failed");
                    }
                    throw new Error("Submission failed");
                }
            } catch (error) {
                console.error(error);
                document.dispatchEvent(
                    new CustomEvent("modal:open", {
                        detail: { modalId: "error-modal" },
                    }),
                );
            } finally {
                if (submitButton) submitButton.style.display = "block";
                if (spinner) spinner.style.display = "none";
            }
        });
    });
</script>
