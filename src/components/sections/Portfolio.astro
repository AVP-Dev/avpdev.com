---
import { getCollection } from "astro:content";
import type { Project, TranslationKey } from "../../env.d.ts";
import PortfolioCard from "../PortfolioCard.astro";
import { getLangFromUrl, useTranslations } from "../../i18n/utils";

const lang = getLangFromUrl(Astro.url) as "ru" | "en";
const t = useTranslations(lang);

// 1. Load collection for current language
const projectsCollection = await getCollection("projects", ({ id, data }) => {
  // Filter for current language AND featured projects
  return id.startsWith(`${lang}/`) && data.featured === true;
});

// 2. Sort by publishDate (descending)
const sortedProjects = projectsCollection.sort(
  (a, b) => b.data.publishDate.valueOf() - a.data.publishDate.valueOf(),
);

// 3. Take top 6
const featuredProjects = sortedProjects.slice(0, 6);

const categoryMap: Record<string, "sites" | "apps"> = {
  "web-site": "sites",
  app: "apps",
  "crm-erp": "apps",
  "tg-mini-app": "apps",
};

const PROJECTS_DATA: Project[] = featuredProjects.map((project, index) => ({
  id: index + 1,
  category: categoryMap[project.data.category] || "sites",
  img: project.data.heroImage,
  titleKey: project.data.header.titleKey as TranslationKey,
  link: `/${lang}/project/${project.slug.replace(/^(ru|en)\//, "")}/`,
  techStack: project.data.content.techStack,
  tags: project.data.stack,
}));
---

<section id="portfolio" aria-labelledby="portfolio-title">
  <div class="container">
    <div class="section-header">
      <h2
        id="portfolio-title"
        class="section-title"
        set:html={t("portfolio_h2")}
      />
      <div class="section-actions fade-in">
        <a href={`/${lang}/projects/`} class="cta-button secondary">
          {t("portfolio_btn_all")}
        </a>
      </div>
    </div>

    {
      PROJECTS_DATA.length > 0 ? (
        <div
          id="main-portfolio-grid"
          class="portfolio-grid fade-in"
          aria-live="polite"
        >
          {PROJECTS_DATA.map((project) => (
            <div class="portfolio-card-wrapper">
              <PortfolioCard {...project} />
            </div>
          ))}
        </div>
      ) : (
        <p class="muted" id="portfolio-empty">
          Проекты скоро появятся.
        </p>
      )
    }
  </div>
</section>

<style>
  .section-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    margin-bottom: 4rem;
    gap: 1.5rem;
  }

  .section-header .section-title {
    margin-bottom: 0;
  }

  .portfolio-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(min(100%, 330px), 1fr));
    gap: 2.5rem;
  }

  @media (max-width: 768px) {
    .section-header {
      margin-bottom: 2.5rem;
      gap: 1.25rem;
    }

    .portfolio-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
