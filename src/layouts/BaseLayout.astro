---
import { ClientRouter } from 'astro:transitions';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import type { ui } from '../i18n/ui';

// --- ШРИФТЫ (Self-hosted) ---
// Это решает проблемы с GDPR и ускоряет загрузку
import '@fontsource/inter/400.css';
import '@fontsource/inter/500.css';
import '@fontsource/inter/600.css';
import '@fontsource/inter/700.css';
import '@fontsource/inter/800.css';

import '../styles/style.css';
import '../styles/case-study.css';
import '../styles/brief.css';
import '../styles/blog.css';

export interface Props {
	title: string;
	description: string;
    ogImage?: string;
    isTranslationKey?: boolean;
    schema?: Record<string, any>;
}

const {
    title,
    description,
    ogImage = '/og-image.webp',
    isTranslationKey = true,
    schema,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const finalTitle = isTranslationKey ? t(title as keyof typeof ui['ru']) : title;
const finalDescription = isTranslationKey ? t(description as keyof typeof ui['ru']) : description;

const canonicalURL = new URL(Astro.url.pathname.endsWith('/') ? Astro.url.pathname : `${Astro.url.pathname}/`, Astro.site);
const GTAG_ID = import.meta.env.PUBLIC_GTAG_ID;
---
<!DOCTYPE html>
<html lang={lang}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{finalTitle}</title>
    <meta name="description" content={finalDescription} />
    
    <link rel="canonical" href={canonicalURL} />

    <meta property="og:title" content={finalTitle} />
    <meta property="og:description" content={finalDescription} />
    <meta property="og:image" content={new URL(ogImage, Astro.site)} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="AVPdev.com" />

    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="manifest" href="/site.webmanifest">

    {/* FontAwesome deferred for performance */}
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" /></noscript>
    
    {/* Вставка Schema.org */}
    {schema && (
        <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    )}

    {GTAG_ID && (
        <>
            {/* Google Tag Manager - PARTYTOWN */}
            <script type="text/partytown" async src={`https://www.googletagmanager.com/gtag/js?id=${GTAG_ID}`}></script>
            <script type="text/partytown" define:vars={{ GTAG_ID }}>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', GTAG_ID);
            </script>
        </>
    )}

    {/* SEO: Hreflang Tags */}
    {() => {
        // 1. Получаем текущий путь
        let currentPath = Astro.url.pathname;
        if (!currentPath.endsWith('/')) {
            currentPath += '/';
        }
        
        // 2. Убираем текущую локаль из пути, чтобы получить "чистый" slug
        // Регулярка удаляет /ru/ или /en/ в начале
        const pathWithoutLocale = currentPath
            .replace(/^\/(ru|en)\//, '/');
        
        // 3. Определяем базовый домен (fallback, если Astro.site не задан)
        const siteBase = Astro.site ? Astro.site.toString() : 'https://avpdev.com';

        // 4. Формируем URL для каждой версии
        // pathWithoutLocale всегда начинается с / и заканчивается /
        // Например: /about/ или /
        
        // Удаляем начальный слэш для объединения с базовым путем
        const cleanSlug = pathWithoutLocale.replace(/^\//, '');

        const ruUrl = new URL(`ru/${cleanSlug}`, siteBase).href;
        const enUrl = new URL(`en/${cleanSlug}`, siteBase).href;

        return (
            <>
                <link rel="alternate" hreflang="ru" href={ruUrl} />
                <link rel="alternate" hreflang="en" href={enUrl} />
                {/* x-default указывает на русскую версию как основную */}
                <link rel="alternate" hreflang="x-default" href={ruUrl} />
            </>
        );
    }}

    <ClientRouter />
</head>
<body class="light-theme">
    <Header />
    <main>
        <slot />
    </main>
    <CookieBanner />
    <Footer />
    <ScrollToTop />
    <script src="/src/scripts/main.ts"></script>
</body>
</html>