---
import { ClientRouter } from 'astro:transitions';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import CookieBanner from '../components/CookieBanner.astro';
import ScrollToTop from '../components/ScrollToTop.astro';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import type { ui } from '../i18n/ui';

// --- ШРИФТЫ (Self-hosted) ---
import '@fontsource-variable/sora';
import '@fontsource-variable/plus-jakarta-sans';
import '@fontsource/jetbrains-mono';

import '../styles/style.css';
import '../styles/case-study.css';
import '../styles/brief.css';
import '../styles/blog.css';

export interface Props {
	title: string;
	description: string;
    ogImage?: string;
    isTranslationKey?: boolean;
    schema?: Record<string, any>;
}

const {
    title,
    description,
    ogImage = '/og-image.webp',
    isTranslationKey = true,
    schema,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const finalTitle = isTranslationKey ? t(title as any) : title;
const finalDescription = isTranslationKey ? t(description as any) : description;

const canonicalURL = new URL(Astro.url.pathname.endsWith('/') ? Astro.url.pathname : `${Astro.url.pathname}/`, Astro.site);
const GTAG_ID = import.meta.env.PUBLIC_GTAG_ID;
---
<!DOCTYPE html>
<html lang={lang}>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>{finalTitle}</title>
    <meta name="description" content={finalDescription} />
    
    <link rel="canonical" href={canonicalURL} />

    <meta property="og:title" content={finalTitle} />
    <meta property="og:description" content={finalDescription} />
    <meta property="og:image" content={new URL(ogImage, Astro.site)} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content="AVPdev.com" />

    <link rel="apple-touch-icon" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="manifest" href="/site.webmanifest">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" media="print" onload="this.media='all'" />
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    </noscript>
    
    {/* Вставка Schema.org */}
    {schema && (
        <script type="application/ld+json" set:html={JSON.stringify(schema)} />
    )}

    {GTAG_ID && (
        <>
            {/* Google Tag Manager - PARTYTOWN */}
            <script type="text/partytown" async src={`https://www.googletagmanager.com/gtag/js?id=${GTAG_ID}`}></script>
            <script type="text/partytown" define:vars={{ GTAG_ID }}>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', GTAG_ID);
            </script>
        </>
    )}

    {/* SEO: Hreflang Tags */}
    {() => {
        // 1. Получаем текущий путь
        let currentPath = Astro.url.pathname;
        if (!currentPath.endsWith('/')) {
            currentPath += '/';
        }
        
        // 2. Убираем текущую локаль из пути, чтобы получить "чистый" slug
        // Регулярка удаляет /ru/ или /en/ в начале
        const pathWithoutLocale = currentPath
            .replace(/^\/(ru|en)\//, '/');
        
        // 3. Определяем базовый домен (fallback, если Astro.site не задан)
        const siteBase = Astro.site ? Astro.site.toString() : 'https://avpdev.com';

        // 4. Формируем URL для каждой версии
        // pathWithoutLocale всегда начинается с / и заканчивается /
        // Например: /about/ или /
        
        // Удаляем начальный слэш для объединения с базовым путем
        const cleanSlug = pathWithoutLocale.replace(/^\//, '');

        const ruUrl = new URL(`ru/${cleanSlug}`, siteBase).href;
        const enUrl = new URL(`en/${cleanSlug}`, siteBase).href;

        return (
            <>
                <link rel="alternate" hreflang="ru" href={ruUrl} />
                <link rel="alternate" hreflang="en" href={enUrl} />
                {/* x-default указывает на русскую версию как основную */}
                <link rel="alternate" hreflang="x-default" href={ruUrl} />
            </>
        );
    }}

    <script is:inline>
        function applyTheme() {
            const theme = (() => {
                if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
                    return localStorage.getItem('theme');
                }
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    return 'dark-theme';
                }
                return 'light-theme';
            })();
            
            if (theme === 'dark-theme') {
                document.documentElement.classList.add('dark-theme');
                document.documentElement.classList.remove('light-theme');
                document.documentElement.style.colorScheme = 'dark';
            } else {
                document.documentElement.classList.add('light-theme');
                document.documentElement.classList.remove('dark-theme');
                document.documentElement.style.colorScheme = 'light';
            }
            window.localStorage.setItem('theme', theme);
        }

        applyTheme();
        document.addEventListener('astro:after-swap', applyTheme);
    </script>

    <ClientRouter />

    <style is:inline>
        /* --- Critical CSS for FOUC prevention --- */
        :root {
            --accent-gradient: linear-gradient(135deg, #FF5C00 0%, #FFB800 100%);
            --accent-color-start: #FF5C00;
            --accent-color-start-rgb: 255, 92, 0;
            --accent-color-end: #FFB800;
            --font-heading: 'Sora Variable', sans-serif;
            --font-body: 'Plus Jakarta Sans Variable', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }

        /* Critical CSS for LCP (Logo) */
        header {
            position: fixed;
            top: 1.25rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1005;
            display: block;
        }
        .logo {
            font-size: 1.25rem;
            font-weight: 800;
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-img {
            height: 32px;
            width: auto;
            aspect-ratio: 40/40;
        }
        .logo-text {
            font-family: var(--font-heading);
            font-weight: 800;
            line-height: 1;
        }

        /* Default background to avoid white flash */
        html {
            background-color: #050505;
            color-scheme: dark; /* Default */
        }

        .light-theme {
            color-scheme: light;
            --bg-color: #FAFAFA;
            --bg-color-rgb: 250, 250, 250;
            --primary-color: #FFFFFF;
            --primary-color-rgb: 255, 255, 255;
            --text-color: #18181B;
            --text-secondary-color: #52525B;
            --border-color: rgba(0, 0, 0, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.05);
            --card-shadow: 0 10px 30px rgba(0, 0, 0, 0.04);
            --particle-color: "#222222";
            --particle-line-color: "#333333";
            --tag-bg: rgba(0, 0, 0, 0.05);
            --tag-text: #3F3F46;
        }

        .dark-theme {
            color-scheme: dark;
            --bg-color: #030305;
            --bg-color-rgb: 3, 3, 5;
            --primary-color: #11111A;
            --primary-color-rgb: 17, 17, 26;
            --text-color: #FFFFFF;
            --text-secondary-color: #94949E;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-bg: rgba(17, 17, 26, 0.8);
            --glass-border: rgba(255, 255, 255, 0.15);
            --card-shadow: 0 25px 60px rgba(0, 0, 0, 0.8);
            --particle-color: "#ffffff";
            --particle-line-color: "#ffffff";
            --tag-bg: rgba(255, 255, 255, 0.08);
            --tag-text: #E4E4E7;
        }

        html.light-theme { background-color: #FAFAFA; }
        html.dark-theme { background-color: #030305; }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-body);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            margin: 0;
            position: relative;
        }

        /* Standardized transition for theme switch button only */
        .theme-transitioning body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.03) 1px, transparent 0);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: -1;
        }
        .dark-theme body::before {
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.02) 1px, transparent 0);
        }
        .light-theme body::before {
            background-image: 
                radial-gradient(circle at 2px 2px, rgba(0, 0, 0, 0.02) 1px, transparent 0);
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-heading);
            font-weight: 700;
            letter-spacing: -0.02em;
        }
    </style>
</head>
<body>
    <Header />
    <main>
        <slot />
    </main>
    <CookieBanner />
    <Footer />
    <ScrollToTop />
    <script src="/src/scripts/main.ts"></script>
</body>
</html>