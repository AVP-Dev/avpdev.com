---
// src/pages/blog/[slug].astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Cta from '../../components/Cta.astro';
import type { CollectionEntry } from 'astro:content';

// ИСПРАВЛЕНИЕ: Явно указываем Astro, что эти страницы нужно сгенерировать во время сборки.
export const prerender = true;

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({data}) => data.draft !== true);
  return allPosts.map(post => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();
const formattedDate = new Date(post.data.pubDate).toLocaleDateString('ru-RU', {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});
---
<BaseLayout 
  title={post.data.title} 
  description={post.data.description}
  isTranslationKey={false}
  ogImage={post.data.heroImage ? post.data.heroImage.src : '/og-image.webp'}
>
  <article class="blog-post-article">
    <header class="blog-post-hero">
        {post.data.heroImage && (
            <div class="hero-image-container">
                <img 
                    src={post.data.heroImage.src}
                    alt={`Обложка статьи: ${post.data.title}`} 
                    width="1200"
                    height="600"
                    loading="eager"
                    decoding="auto"
                    style="object-fit: cover; width: 100%; height: 100%;"
                />
            </div>
        )}
        <div class="hero-content-overlay">
            <div class="blog-post-container">
                <h1 class="post-title">{post.data.title}</h1>
                <div class="post-meta">
                    <time datetime={post.data.pubDate.toISOString()}>{formattedDate}</time>
                    <div class="tags">
                        {post.data.tags.map(tag => <span class="tag">{tag}</span>)}
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="blog-post-container content-wrapper">
        <div class="post-content">
            <Content />
        </div>
        
        <Cta />
    </div>

    <div class="blog-post-container">
        <div class="back-link-wrapper">
            <a href="/blog/" class="back-to-main" data-lang="blog_back_to_all"></a>
        </div>
    </div>
  </article>
</BaseLayout>
