---
// src/pages/ru/blog/index.astro
import { getCollection } from "astro:content";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import BlogCard from "../../../components/BlogCard.astro";
import FeaturedPostCard from "../../../components/FeaturedPostCard.astro";
import { getLangFromUrl, useTranslations } from "../../../i18n/utils";

export const prerender = true;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

// Получаем все посты для текущего языка, исключая черновики
const allPosts = await getCollection("blog", ({ id, data }) => {
  return id.startsWith(lang + "/") && data.draft !== true;
});

// Сортируем посты по дате от новых к старым
allPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf(),
);

const hasPosts = allPosts.length > 0;
const latestPost = hasPosts ? allPosts[0] : null;
const otherPosts = hasPosts ? allPosts.slice(1) : [];

// Собираем все уникальные теги для кнопок-фильтров
// const allTags = [...new Set(allPosts.flatMap(post => post.data.tags))];
---

<BaseLayout title="blog_page_title" description="blog_page_desc">
  <section id="blog-list" class="blog-page">
    <div class="container">
      <div class="blog-header fade-in">
        <h1 class="section-title" set:html={t("blog_h1")} />
        <p class="section-subtitle">{t("blog_p")}</p>
      </div>

      <!-- Отображаем последний пост отдельно -->
      {
        hasPosts && latestPost && (
          <div class="featured-post-section fade-in">
            <h2>{t("blog_latest_post")}</h2>
            <FeaturedPostCard post={latestPost} />
          </div>
        )
      }

      <!-- Отображаем остальные посты и фильтры -->
      {
        otherPosts.length > 0 && (
          <div
            class="posts-list-section fade-in"
            style="transition-delay: 200ms;"
          >
            {otherPosts.length > 0 && <h2>{t("blog_other_posts")}</h2>}

            <div class="filters-container">
              <div
                class="search-wrapper"
                style="margin: 0 auto; max-width: 600px; width: 100%;"
              >
                <i class="fas fa-search search-icon" aria-hidden="true" />
                <input
                  type="search"
                  id="blog-search"
                  placeholder={t("blog_search_placeholder")}
                  aria-label="Поиск по статьям"
                  style="width: 100%;"
                />
              </div>
            </div>

            {otherPosts.length > 0 && (
              <div id="posts-grid" class="portfolio-grid blog-grid">
                {otherPosts.map((post) => (
                  <BlogCard post={post} />
                ))}
              </div>
            )}
          </div>
        )
      }

      <p
        id="no-results-message"
        class="no-results-message"
        style="display: none;"
      >
        {t("blog_no_results")}
      </p>

      {!hasPosts && <p class="no-results-message">{t("blog_no_posts_yet")}</p>}
    </div>
  </section>
</BaseLayout>

<script>
  document.addEventListener("astro:page-load", () => {
    const searchInput = document.getElementById(
      "blog-search",
    ) as HTMLInputElement | null;
    const postsGrid = document.getElementById("posts-grid");
    const noResultsMessage = document.getElementById("no-results-message");

    if (!postsGrid || !searchInput || !noResultsMessage) {
      return;
    }

    const allCards = Array.from(
      postsGrid.querySelectorAll<HTMLElement>(".blog-card-link"),
    );

    let currentQuery = "";

    function filterPosts() {
      let visibleCount = 0;

      allCards.forEach((card) => {
        const title = card.dataset.title || "";
        const description = card.dataset.description || "";
        const tags = card.dataset.tags || "";

        const matchesQuery =
          currentQuery === "" ||
          title.includes(currentQuery) ||
          description.includes(currentQuery) ||
          tags.includes(currentQuery);

        const isVisible = matchesQuery;

        card.style.display = isVisible ? "" : "none";

        if (isVisible) {
          visibleCount++;
        }
      });

      if (noResultsMessage) {
        noResultsMessage.style.display = visibleCount === 0 ? "block" : "none";
      }
    }

    searchInput.addEventListener("input", (e) => {
      currentQuery = (e.target as HTMLInputElement).value.toLowerCase().trim();
      filterPosts();
    });
  });
</script>
