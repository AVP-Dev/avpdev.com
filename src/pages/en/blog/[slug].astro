---
// src/pages/en/blog/[slug].astro
import { getCollection } from 'astro:content';
import BaseLayout from '../../../layouts/BaseLayout.astro';
import Cta from '../../../components/Cta.astro';
import type { CollectionEntry } from 'astro:content';
import { getLangFromUrl, useTranslations } from '../../../i18n/utils';

export const prerender = true;

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ id }) => id.startsWith('en/'));
  return allPosts.map(post => ({
    params: { slug: post.slug.replace('en/', '') },
    props: { post },
  }));
}

interface Props {
  post: CollectionEntry<'blog'>;
}

const { post } = Astro.props;
const { Content } = await post.render();

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const formattedDate = new Date(post.data.pubDate).toLocaleDateString(lang, {
  year: 'numeric',
  month: 'long',
  day: 'numeric'
});

const backLink = `/${lang}/blog/`;

const breadcrumbSchema = {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    "itemListElement": [
        {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": new URL(`/${lang}/`, Astro.site).href
        },
        {
            "@type": "ListItem",
            "position": 2,
            "name": "Blog",
            "item": new URL(`/${lang}/blog/`, Astro.site).href
        },
        {
            "@type": "ListItem",
            "position": 3,
            "name": post.data.title,
            "item": new URL(Astro.url.pathname, Astro.site).href
        }
    ]
};

const articleSchema = {
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": post.data.title,
    "description": post.data.description,
    "author": {
        "@type": "Person",
        "name": "Alexey Patskevich",
        "url": Astro.site ? Astro.site.toString() : ""
    },
    "datePublished": post.data.pubDate.toISOString(),
    "image": post.data.heroImage ? new URL(post.data.heroImage.src, Astro.site).href : "",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": new URL(Astro.url.pathname, Astro.site).href
    }
};
---
<BaseLayout
  title={post.data.title}
  description={post.data.description}
  isTranslationKey={false}
  ogImage={post.data.heroImage ? post.data.heroImage.src : '/og-image.webp'}
  schema={[breadcrumbSchema, articleSchema]}
>
  <article class="blog-post-article">
    <header class="blog-post-hero">
        {post.data.heroImage && (
            <div class="hero-image-container">
                <img
                    src={post.data.heroImage.src}
                    alt={`Cover for article: ${post.data.title}`}
                    width="1200"
                    height="600"
                    loading="eager"
                    decoding="auto"
                    style="object-fit: cover; width: 100%; height: 100%;"
                />
            </div>
        )}
        <div class="hero-content-overlay">
            <div class="blog-post-container">
                <h1 class="post-title">{post.data.title}</h1>
                <div class="post-meta">
                    <time datetime={post.data.pubDate.toISOString()}>{formattedDate}</time>
                    <div class="tags">
                        {post.data.tags.map(tag => <span class="tag">{tag}</span>)}
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="blog-post-container content-wrapper">
        <div class="post-content">
            <Content />
        </div>

        <Cta />
    </div>

    <div class="blog-post-container">
        <div class="back-link-wrapper">
            <a href={backLink} class="back-to-main">{t('blog_back_to_all')}</a>
        </div>
    </div>
  </article>
</BaseLayout>
