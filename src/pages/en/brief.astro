---
// src/pages/en/brief.astro
import BaseLayout from '../../layouts/BaseLayout.astro';
import SuccessModal from '../../components/modals/SuccessModal.astro';
import ErrorModal from '../../components/modals/ErrorModal.astro';
import { getLangFromUrl, useTranslations } from '../../i18n/utils';

export const prerender = true;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---
<BaseLayout title="brief_page_title" description="brief_page_desc">
    <section id="brief-form-section" class="case-study-header">
        <div class="container">
            <h1 class="section-title">{t('brief_title')}</h1>
            <p>{t('brief_subtitle')}</p>

            <form id="brief-form" class="brief-form" novalidate>
                <fieldset class="form-block fade-in">
                    <legend>1. Contact Information</legend>
                    <div class="form-group">
                        <label for="company_name">Name / Company Name *</label>
                        <input type="text" id="company_name" name="company_name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="contacts">Contact Info (Phone, Telegram, Email) *</label>
                        <input type="text" id="contacts" name="contacts" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Preferred method of contact *</label>
                        <div class="radio-group">
                            <label><input type="radio" name="preferred_contact" value="Telegram" checked><span>Telegram</span></label>
                            <label><input type="radio" name="preferred_contact" value="WhatsApp"><span>WhatsApp</span></label>
                            <label><input type="radio" name="preferred_contact" value="Email"><span>Email</span></label>
                            <label><input type="radio" name="preferred_contact" value="Phone Call"><span>Phone Call</span></label>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-block fade-in" style="transition-delay: 100ms;">
                    <legend>2. About the Company and Project</legend>
                    <div class="form-group">
                        <label for="business_sphere">Briefly describe what your company does, what products or services it offers? *</label>
                        <textarea id="business_sphere" name="business_sphere" class="form-control" rows="3" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="current_site">Current website address (if any)</label>
                        <input type="url" id="current_site" name="current_site" class="form-control" placeholder="https://">
                    </div>
                    <div class="form-group">
                        <label for="competitors">List 2-3 main competitors</label>
                        <textarea id="competitors" name="competitors" class="form-control" rows="2" placeholder="Links to competitors' websites"></textarea>
                    </div>
                </fieldset>

                <fieldset class="form-block fade-in" style="transition-delay: 200ms;">
                    <legend>3. Website Goals and Objectives</legend>
                    <div class="form-group">
                        <label>What is the main goal of creating the website? *</label>
                         <div class="radio-group-vertical">
                            <label><input type="radio" name="project_goal" value="Selling products or services online" checked><span>Selling products or services online</span></label>
                            <label><input type="radio" name="project_goal" value="Customer acquisition (lead generation)"><span>Customer acquisition (lead generation)</span></label>
                            <label><input type="radio"name="project_goal" value="Corporate image representation"><span>Corporate image representation</span></label>
                             <label><input type="radio" name="project_goal" value="Information portal or blog"><span>Information portal or blog</span></label>
                             <label><input type="radio" name="project_goal" value="Automation of internal processes"><span>Automation of internal processes</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="success_metrics">How will you measure the success of the site? (e.g., N leads per month, X% sales growth)</label>
                        <textarea id="success_metrics" name="success_metrics" class="form-control" rows="2"></textarea>
                    </div>
                </fieldset>

                <fieldset class="form-block fade-in" style="transition-delay: 300ms;">
                    <legend>4. Target Audience</legend>
                     <div class="form-group">
                        <label for="target_audience">Describe your typical client (age, interests, occupation)</label>
                        <textarea id="target_audience" name="target_audience" class="form-control" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="user_action">What key action should a visitor take on the site?</label>
                        <input type="text" id="user_action" name="user_action" class="form-control" placeholder="For example: call, leave a request, buy a product">
                    </div>
                </fieldset>

                <fieldset class="form-block fade-in" style="transition-delay: 400ms;">
                    <legend>5. Website Type and Functionality</legend>
                    <div class="form-group">
                        <label>What type of website do you need? *</label>
                        <div class="radio-group">
                            <label><input type="radio" name="site_type" value="Landing Page" checked><span>Landing Page</span></label>
                            <label><input type="radio" name="site_type" value="Corporate Website"><span>Corporate Website</span></label>
                            <label><input type="radio" name="site_type" value="E-commerce Store"><span>E-commerce Store</span></label>
                            <label><input type="radio" name="site_type" value="Web Application"><span>Web Application</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>What functionality is needed?</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="features" value="Product/Service Catalog"><span>Product/Service Catalog</span></label>
                            <label><input type="checkbox" name="features" value="Blog/News"><span>Blog/News</span></label>
                             <label><input type="checkbox" name="features" value="User Account"><span>User Account</span></label>
                            <label><input type="checkbox" name="features" value="Online Payments"><span>Online Payments</span></label>
                            <label><input type="checkbox" name="features" value="Cost Calculator"><span>Cost Calculator</span></label>
                             <label><input type="checkbox" name="features" value="Multilingual Support"><span>Multilingual Support</span></label>
                             <label><input type="checkbox" name="features" value="other"><span>Other</span></label>
                        </div>
                        <div class="form-group other-input" style="display: none;">
                            <input type="text" name="features_other" class="form-control" placeholder="Specify other functionality">
                        </div>
                    </div>
                </fieldset>

                 <fieldset class="form-block fade-in" style="transition-delay: 500ms;">
                    <legend>6. Design and Content</legend>
                     <div class="form-group">
                        <label>Do you have a corporate identity, logo, brand book?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="brand_identity" value="Yes, we have everything" checked><span>Yes, we have everything</span></label>
                            <label><input type="radio" name="brand_identity" value="Only have a logo"><span>Only have a logo</span></label>
                            <label><input type="radio" name="brand_identity" value="No, we need it developed"><span>No, we need it developed</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="design_examples">Provide 2-3 examples of websites you like for their design</label>
                        <textarea id="design_examples" name="design_examples" class="form-control" rows="2" placeholder="Links to websites"></textarea>
                    </div>
                     <div class="form-group">
                        <label>Who will prepare the content (texts, photos, videos)?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="content_provider" value="We have ready content" checked><span>We have ready content</span></label>
                            <label><input type="radio" name="content_provider" value="We will prepare the content"><span>We will prepare the content</span></label>
                            <label><input type="radio" name="content_provider" value="We need help with preparation"><span>We need help with preparation</span></label>
                        </div>
                    </div>
                </fieldset>

                 <fieldset class="form-block fade-in" style="transition-delay: 600ms;">
                    <legend>7. Technical Questions</legend>
                     <div class="form-group">
                        <label>Do you have a domain and hosting?</label>
                        <div class="radio-group">
                            <label><input type="radio" name="hosting_domain" value="Yes, we do" checked><span>Yes, we do</span></label>
                            <label><input type="radio" name="hosting_domain" value="No, we need help"><span>No, we need help</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="integrations">Are integrations with third-party services needed (CRM, accounting, delivery services, analytics)?</label>
                        <textarea id="integrations" name="integrations" class="form-control" rows="2" placeholder="For example: Bitrix24, Google Analytics"></textarea>
                    </div>
                </fieldset>

                <fieldset class="form-block fade-in" style="transition-delay: 700ms;">
                    <legend>8. Budget and Timeline</legend>
                    <div class="form-group">
                        <label>Estimated development budget?</label>
                        <div class="radio-group-vertical">
                            <label><input type="radio" name="budget" value="Up to $500" checked><span>Up to $500</span></label>
                            <label><input type="radio" name="budget" value="$500 - $1500"><span>$500 - $1500</span></label>
                            <label><input type="radio" name="budget" value="$1500 - $3000"><span>$1500 - $3000</span></label>
                            <label><input type="radio" name="budget" value="More than $3000"><span>More than $3000</span></label>
                             <label><input type="radio" name="budget" value="To be discussed individually"><span>To be discussed individually</span></label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="deadline">Desired project launch date?</label>
                        <input type="text" id="deadline" name="deadline" class="form-control">
                    </div>
                </fieldset>

                 <fieldset class="form-block fade-in" style="transition-delay: 800ms;">
                    <legend>9. Additional Information</legend>
                    <div class="form-group">
                        <label for="additional_info">Here you can provide any other important information that will help to better understand your task.</label>
                        <textarea id="additional_info" name="additional_info" class="form-control" rows="4"></textarea>
                    </div>
                </fieldset>

                <fieldset class="form-block fade-in" style="transition-delay: 900ms;">
                    <legend>10. Support and Development</legend>
                    <div class="form-group">
                        <label>Do you need support, maintenance, or further development of the site after launch?</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="support" value="Yes, technical support is needed"><span>Yes, technical support is needed</span></label>
                            <label><input type="checkbox" name="support" value="Yes, further development is planned"><span>Yes, further development is planned</span></label>
                            <label><input type="checkbox" name="support" value="No, not required at this stage"><span>No, not required at this stage</span></label>
                            <label><input type="checkbox" name="support" value="I'm not sure"><span>I'm not sure</span></label>
                        </div>
                    </div>
                </fieldset>

                <div class="form-submit-container">
                    <button id="submit-button" type="submit" class="cta-button">{t('form_button')}</button>
                    <div id="form-spinner" class="spinner" style="display: none;"></div>
                </div>
            </form>
        </div>
    </section>

    <SuccessModal />
    <ErrorModal />
</BaseLayout>

<script>
document.addEventListener('astro:page-load', () => {
    const form = document.getElementById('brief-form') as HTMLFormElement;
    if (!form) return;

    // --- Logic to show/hide the "Other" field ---
    const otherCheckboxes = form.querySelectorAll<HTMLInputElement>('input[type="checkbox"][value="other"]');
    otherCheckboxes.forEach(checkbox => {
        const otherInputDiv = checkbox.closest('.checkbox-group')?.nextElementSibling as HTMLElement | null;
        if (otherInputDiv && otherInputDiv.classList.contains('other-input')) {
            checkbox.addEventListener('change', () => {
                otherInputDiv.style.display = checkbox.checked ? 'block' : 'none';
            });
        }
    });

    // --- Form submission logic ---
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const spinner = document.getElementById('form-spinner') as HTMLElement;

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        let isValid = true;
        form.querySelectorAll<HTMLInputElement | HTMLTextAreaElement>('[required]').forEach(field => {
            field.classList.remove('error-field');
            if (!field.value.trim()) {
                field.classList.add('error-field');
                isValid = false;
            }
        });

        if (!isValid) {
            (form.querySelector('.error-field') as HTMLElement)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return;
        }

        submitButton.style.display = 'none';
        spinner.style.display = 'block';

        const formData = new FormData(form);
        const data: { [key: string]: any } = {};

        for (let [key, value] of formData.entries()) {
            if (data[key]) {
                if (!Array.isArray(data[key])) {
                    data[key] = [data[key]];
                }
                data[key].push(value);
            } else {
                data[key] = value;
            }
        }

        try {
            const response = await fetch('/api/sendBrief/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if (response.ok) {
                document.dispatchEvent(new CustomEvent('modal:open', { detail: { modalId: 'success-modal' } }));
                form.reset();
            } else {
                throw new Error('Server response was not ok.');
            }
        } catch (error) {
            console.error('Brief submission error:', error);
            document.dispatchEvent(new CustomEvent('modal:open', { detail: { modalId: 'error-modal' } }));
        } finally {
            submitButton.style.display = 'block';
            spinner.style.display = 'none';
        }
    });
});
</script>